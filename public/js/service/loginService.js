angular.module("johayo.service").factory("loginService",['$http','$q','$rootScope','loginRetryQueue','ngDialog',function($http,$q,$rootScope,queue,ngDialog){var loginDialog=null;function openLoginDialog(){if(loginDialog){throw new Error('Trying to open a dialog that is already open!');}loginDialog=ngDialog.open({template:'/html/login/login.html',controller:'loginController',className:'ngdialog-theme-default ngdialog-theme-custom'});return loginDialog;}function onLoginDialogClose(success){loginDialog=null;if(success()){queue.retryAll();}else{queue.cancelAll();}}queue.onItemAddedCallbacks.push(function(){if(queue.hasMore()){service.openLogin();}});var service={getLoginReason:function(){return queue.retryReason();},openLogin:function(){ngDialog.close();var asy=$q.defer();openLoginDialog().closePromise.then(function(){onLoginDialogClose(service.isLogin);service.finalLogin();asy.resolve();});return asy.promise;},doLogin:function(login){var asy=$q.defer();$http.post('/api/login',login).success(function(data){service.loginInfo=data;service.finalLogin();asy.resolve(data);}).error(function(data,st){asy.reject(data);});return asy.promise;},logout:function(){var asy=$q.defer();$http.post('/api/login/logout').then(function(){service.loginInfo=null;service.finalLogin();asy.resolve();});return asy.promise;},getLoginInfo:function(){var asy=$q.defer();if(service.isLogin()){asy.resolve(service.loginInfo);}else{$http.post('/api/login/getLogin').then(function(response){service.loginInfo=response.data;asy.resolve(service.loginInfo);});}return asy.promise;},isLogin:function(){return!!service.loginInfo;},getCheckLogin:function(){var asy=$q.defer();$http.post('/api/login/check').then(function(){asy.resolve();});return asy.promise;},finalLogin:function(){$rootScope.$broadcast('getLoginInfo');},loginInfo:null};return service;}]);